<div class="cartao">
  <h3>Estudos Anteriores</h3>
  <p class="sub">Registre sess√µes de estudo e provas realizadas.</p>

  <div style="margin-top:10px">
    <label>Mat√©ria</label>
    <select id="previos-subject"></select>

    <div class="linha" style="margin-top:8px">
      <div style="flex:1;margin-right:8px">
        <label>Horas</label>
        <input id="previos-hours" type="number" step="0.1" value="1" />
      </div>
      <div style="flex:1">
        <label>Qualidade (0.2 - 1.4)</label>
        <input id="previos-quality" type="number" step="0.01" value="1.0" />
      </div>
    </div>

    <label style="margin-top:8px">Dificuldade</label>
    <select id="previos-difficulty"><option value="1">F√°cil</option><option value="2" selected>M√©dio</option><option value="3">Dif√≠cil</option></select>

    <label style="margin-top:8px">Nota (se for prova)</label>
    <input id="previos-grade" type="number" step="0.1" min="0" max="10" />

    <button id="previos-add" class="botao" style="margin-top:10px">Salvar sess√£o</button>
    <div id="previos-result" class="resultado" style="display:none"></div>

    <h4 style="margin-top:14px">√öltimas sess√µes</h4>
    <table id="previos-table"><thead><tr><th>Data</th><th>Mat√©ria</th><th>Horas</th><th>Qualidade</th><th>Dificuldade</th><th>Nota</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>

    <canvas id="previos-chart" style="margin-top:12px" height="200"></canvas>
  </div>
</div>

<script>
async function loadSubjectsInto(selectEl){
  const res = await fetch('/api/subjects'); const subs = await res.json();
  selectEl.innerHTML = '<option value="">-- escolha --</option>';
  subs.forEach(s=> selectEl.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name}</option>`));
}
async function refreshPrevios(){
  const table = document.querySelector('#previos-table tbody');
  const res = await fetch('/api/entries'); const datas = await res.json();
  table.innerHTML = '';
  datas.forEach(d=>{
    table.insertAdjacentHTML('beforeend', `<tr data-id="${d.id}"><td>${d.date}</td><td>${d.subject_name}</td><td>${d.hours}</td><td>${d.quality}</td><td>${d.difficulty}</td><td>${d.grade ?? ''}</td><td><button class="del">üóëÔ∏è</button></td></tr>`);
  });
  document.querySelectorAll('#previos-table .del').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr'); const id = tr.dataset.id;
    await fetch('/api/entries?id='+id, {method:'DELETE'}); refreshPrevios();
  });

  // chart: grades timeline
  const ctx = document.getElementById('previos-chart').getContext('2d');
  const withGrade = datas.filter(d=>d.grade !== null && d.grade !== undefined);
  const labels = withGrade.map(x=> x.date + ' - ' + x.subject_name);
  const grades = withGrade.map(x=> x.grade);
  if (window.previosChart) window.previosChart.destroy();
  window.previosChart = new Chart(ctx, {type:'line', data:{labels, datasets:[{label:'Nota', data:grades, fill:false, borderColor:'#7c3aed'}]}, options:{scales:{y:{min:0,max:10}}}});
}

document.getElementById('previos-add').onclick = async ()=>{
  const subject_id = document.getElementById('previos-subject').value;
  if (!subject_id) return alert('Escolha uma mat√©ria');
  const payload = {
    subject_id,
    hours: parseFloat(document.getElementById('previos-hours').value||0),
    quality: parseFloat(document.getElementById('previos-quality').value||1),
    difficulty: parseInt(document.getElementById('previos-difficulty').value),
    grade: document.getElementById('previos-grade').value || null,
    date: new Date().toISOString().slice(0,10)
  };
  const res = await fetch('/api/entries', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  if (res.ok) {
    document.getElementById('previos-result').style.display='block';
    document.getElementById('previos-result').innerText = 'Salvo!';
    await refreshPrevios();
    setTimeout(()=>document.getElementById('previos-result').style.display='none',1200);
  } else {
    alert('Erro ao salvar');
  }
};

window.addEventListener('tab-changed', async (e)=>{ if (e.detail !== 'previos') return; await loadSubjectsInto(document.getElementById('previos-subject')); await refreshPrevios(); });
</script>
