<div class="cartao">
  <h3>Desempenho Geral</h3>
  <p class="sub">Média por matéria e evolução das notas ao longo do tempo.</p>

  <div style="display:flex;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:280px">
      <h4>Média por matéria</h4>
      <canvas id="perf-avg" height="200"></canvas>
    </div>
    <div style="flex:1;min-width:280px">
      <h4>Evolução das notas</h4>
      <canvas id="perf-timeline" height="200"></canvas>
    </div>
  </div>
</div>

<script>
async function loadPerformance(){
  const res = await fetch('/api/performance'); const j = await res.json();
  const avgLabels = j.avg.map(x=>x.subject);
  const avgData = j.avg.map(x=>parseFloat(x.avg.toFixed(2)));
  const ctx1 = document.getElementById('perf-avg').getContext('2d');
  if (window.perfAvg) window.perfAvg.destroy();
  window.perfAvg = new Chart(ctx1, {type:'bar', data:{labels:avgLabels, datasets:[{label:'Média', data:avgData, backgroundColor:'rgba(124,58,237,0.6)'}]}, options:{scales:{y:{min:0,max:10}}}});

  // timeline
  const timeline = j.timeline;
  const labels = timeline.map(x=> x.date + ' - ' + x.subject);
  const data = timeline.map(x=> x.grade);
  const ctx2 = document.getElementById('perf-timeline').getContext('2d');
  if (window.perfTime) window.perfTime.destroy();
  window.perfTime = new Chart(ctx2, {type:'line', data:{labels, datasets:[{label:'Nota', data, borderColor:'#2dd4bf', fill:false}]}, options:{scales:{y:{min:0,max:10}}}});
}
window.addEventListener('tab-changed', async (e)=>{ if (e.detail !== 'desempenho') return; await loadPerformance(); });
</script>
